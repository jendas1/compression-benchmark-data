$(".nav-tabs a").click(function(a){a.preventDefault();"#sam"==$(this).attr("href")?(title="SAM/BAM",loc="data_sam.json"):(title="FASTQ",loc="data_fastq.json");$("#toolbar").text(title);$(".filter-show-clear").trigger("click");$("#table").bootstrapTable("showLoading");$.ajax({type:"GET",url:loc,dataType:"json",success:function(a){$("select[class*='bootstrap-table-filter-control']").empty();$("#table").bootstrapTable("hideLoading");$("#table").data("url",loc);$("#table").bootstrapTable("load",a)}})});
$("#table").bootstrapTable({search:!0,toggle:"table",toolbar:"#toolbar",showToggle:!0,showColumns:!0,showPaginationSwitch:!0,pagination:!0,pageSize:20,pageList:[20,50,100,"ALL"],showFooter:!1,filterControl:!0,columns:[[{title:"Sample",align:"center",colspan:4},{field:"tool",title:"Tool",rowspan:2,align:"left",valign:"center",sortable:!0,formatter:formatTool,filterControl:"select",filterStrictSearch:!0},{field:"threads",title:"Threads",rowspan:2,align:"right",valign:"center",sortable:!0,filterControl:"select"},
{field:"size",title:"Size (MB)",rowspan:2,align:"right",valign:"center",sortable:!0,formatter:formatSize,events:{"click .sizedetails":sizeDetails},filterControl:"input",customSearch:function(a,b){y=parseInt(b)/1E3/1E3;return isNaN(y)?!0:rangeSearch(a,y)}},{field:"seq",title:"Sequence size (MB)",rowspan:2,align:"right",valign:"center",sortable:!0,formatter:formatSize,filterControl:"input",customSearch:function(a,b){y=parseInt(b)/1E3/1E3;return isNaN(y)?!0:rangeSearch(a,y)},visible:!1},{field:"qual",
title:"Quality size (MB)",rowspan:2,align:"right",valign:"center",sortable:!0,formatter:formatSize,filterControl:"input",customSearch:function(a,b){y=parseInt(b)/1E3/1E3;return isNaN(y)?!0:rangeSearch(a,y)},visible:!1},{field:"rname",title:"Read identifier size (MB)",rowspan:2,align:"right",valign:"center",sortable:!0,formatter:formatSize,filterControl:"input",customSearch:function(a,b){y=parseInt(b)/1E3/1E3;return isNaN(y)?!0:rangeSearch(a,y)},visible:!1},{title:"Compression Details",colspan:3,align:"center"},
{title:"Decompression Details",colspan:3,align:"center"},{title:"Equal output",field:"eq_file",align:"center",rowspan:2,sortable:!0,formatter:formatBool}],[{field:"sample",title:"Sample",sortable:!0,filterControl:"select"},{field:"species",title:"Species",sortable:!0,formatter:function(a){return"<i>"+a+"</i>"},filterControl:"select"},{field:"platform",title:"Platform",sortable:!0,filterControl:"select"},{field:"coverage",title:"Coverage (x)",sortable:!0,filterControl:"input",customSearch:rangeSearch},
{field:"status",title:"Succeeded",sortable:!0,align:"center",formatter:formatBool},{field:"walltime_ratio",title:"Time",sortable:!0,align:"right",formatter:formatTimeRatio,events:{"click .timedetails":timeDetails},filterControl:"input",customSearch:rangeSearch},{field:"memory",title:"Memory (MB)",sortable:!0,align:"right",formatter:formatNumber,filterControl:"input",customSearch:rangeSearch},{field:"d_status",title:"Succeeded",sortable:!0,align:"center",formatter:formatBool},{field:"d_walltime_ratio",
title:"Time",sortable:!0,align:"right",formatter:formatNumber,filterControl:"input",customSearch:rangeSearch,formatter:formatTimeRatio,events:{"click .timedetails":timeDetails}},{field:"d_memory",title:"Memory (MB)",sortable:!0,align:"right",formatter:formatNumber,filterControl:"input",customSearch:rangeSearch}]],detailView:!0,detailFormatter:detailFormatter,striped:!0,filterShowClear:!0,onResetView:function(){$(".sizedetails").popover({title:"Size distribution",content:"",html:!0,placement:"auto left"});
$(".timedetails").popover({title:"Time details",content:"",html:!0,placement:"auto left"})}});
function rangeSearch(a,b){fn=function(a,b){return-1!==(a+"").toLowerCase().indexOf(b)};if(!a||0==a.length)return!0;if(2>a.length)return fn(b,a);if("number"!==typeof b)return!1;switch(a[0]){case "<":a=a.substr(1);fn=function(a,b){return a<b};break;case ">":a=a.substr(1),fn=function(a,b){return a>b}}if(1<a.length)switch(a[0]){case "=":a=a.substr(1),_fn=fn,fn=function(a,b){return a==b||_fn(a,b)}}return fn(b,a)}
function formatNumber(a){return a&&"?"!=a?sprintf("%.2f",a).replace(/\B(?=(\d{3})+(?!\d))/g,",").replace(".00",""):"-"}function formatTime(a){if(!a||"?"==a)return"N/A";var b=parseInt(a/3600)%24,c=parseInt(a/60)%60;a=parseInt(a%60);return(10>b?"0"+b:b)+":"+(10>c?"0"+c:c)+":"+(10>a?"0"+a:a)}function formatBool(a){return'<input type="checkbox" onclick="return false;" onkeydown="return false;" '+(1==a?"checked":"")+"/>"}
window.tools={cbc:"CBC",scramble:"Scramble","scramble-noref":"Scramble (without reference)","scramble-bzip2":"Scramble (with bzip2)",cramtools:"CRAMTools",deez:"DeeZ","deez-qual":"DeeZ (with bzip2 and sam_comp qualities)",samtools:"SAMtools",picard:"Picard",quip:"Quip","quip-asm":"Quip (assembly)","quip-ref":"Quip (with reference)",sambamba:"Sambamba",tsc:"TSC",beetl:"BEETL",dsrc:"DSRC","dsrc-m2":"DSRC (m2 mode)",fastqz:"Fastqz",fqzcomp:"Fqzcomp","fqzcomp-extra":"Fqzcomp (extra mode)",kic:"KIC",kpath:"k-Path",
leon:"Leon",lfqc:"LFQC","lw-fqzip":"LWFQZip",mince:"Mince (paired mode)","mince-single":"Mince",orcom:"ORCOM",scalce:"SCALCE (paired mode)","scalce-single":"SCALCE",slimfastq:"Slimfastq",sra:"NCBI SRA",fqc:"FQC"};
window.fields={command:"Command",exitcode:"Exit code",walltime:"Total time",real:"Linux real time",user:"Linux user time",sys:"Linux system time",process_pid:"Process PID",d_size:"Decompressed size (bytes)",eq_file:"File equality",eq_cmp:"UNIX cmp tool equality",eq_comment:"SAM header equality",records:"Number of records/reads",size:"Total",seq:"Sequences",qual:"Quality scores",rname:"Read identifiers",aux:"Auxiliary data",pe:"Paired-end data"};
function indict(a,b){return a in b||0!=a.indexOf("eq_")?a in b?b[a]:a:a.substr(3)}function formatTool(a){return indict(a,window.tools)}
function detailFormatter(a,b){console.log(b);var c=[];ifn=function(a){a.f||(a.f=function(a){return a});return function(g,d){"d_"==d.substr(0,2)&&(d=d.substr(2));d in b&&null!=b[d]&&"-"!=a.f(b[d])&&c.push("<dt>"+indict(d,window.fields)+"</dt><dd>"+a.f(b[d])+"</dd>")}};c.push("<h3>Compression</h3><hr/>");c.push("<h4>Invocation</h4>");c.push("<dl>");$.each(["command","exitcode","stdin"],ifn({}));$.each(["stdout","stderr"],ifn({f:function(a){if(".log"!=a.substr(a.length-4))return a;file="logs/"+encodeURIComponent(b.sample+
"."+b.tool+"."+b.threads+".cmp.log");return'<a class="loader" href="'+file+'" onclick="loader_init(this);return false;">'+a+"</a>"}}));c.push("</dl>");c.push("<h4>Timings</h4>");c.push("<dl>");$.each(["walltime","real","user","sys"],ifn({f:formatTime}));c.push("</dl>");c.push("<h4>Resources</h4>");c.push("<dl>");$.each("process_pid ru_inblock ru_majflt ru_maxrss ru_minflt ru_nivcsw ru_nvcsw ru_oublock ru_stime ru_utime".split(" "),ifn({}));c.push("</dl>");c.push("<h3>Decompression</h3><hr/>");c.push("<h4>Invocation</h4>");
c.push("<dl>");$.each(["d_command","d_exitcode","d_stdin"],ifn({}));$.each(["d_stdout","d_stderr"],ifn({f:function(a){if(".log"!=a.substr(a.length-4))return a;file="logs/"+encodeURIComponent(b.sample+"."+b.tool+"."+b.threads+".cmp.log");return'<a class="loader" href="'+file+'" onclick="loader_init(this);return false;">'+a+"</a>"}}));c.push("</dl>");c.push("<h4>Timings</h4>");c.push("<dl>");$.each(["d_walltime","d_real","d_user","d_sys"],ifn({f:formatTime}));c.push("</dl>");c.push("<h4>Resources</h4>");
c.push("<dl>");$.each("d_process_pid d_ru_inblock d_ru_majflt d_ru_maxrss d_ru_minflt d_ru_nivcsw d_ru_nvcsw d_ru_oublock d_ru_stime d_ru_utime".split(" "),ifn({}));c.push("</dl>");c.push("<h3>Size & Equality</h3><hr/>");c.push("<h4>Compressed sizes</h4>");c.push("<dl>");$.each("records size seq pe aux qual rname".split(" "),ifn({f:formatNumber}));c.push("</dl>");c.push("<h4>Equality</h4>");c.push("<dl>");$.each(["d_size"],ifn({f:formatNumber}));arr=["eq_file","eq_cmp","eq_comment"];$.each(arr.concat(Object.keys(b).filter(function(a){return-1==
arr.indexOf(a)&&0==a.indexOf("eq_")})),ifn({f:function(a){return!0===a?"Equal":!1===a?"Not equal":a}}));c.push("</dl>");return c.join("")}function loader_init(a){file=$(a).attr("href");p=$(a).parent();p.next().is("pre")?p.next().remove():$.ajax({url:file,beforeSend:function(){p.after("<pre>Loading...</pre>")},success:function(a){p.next().is("pre")&&p.next().text(a)},error:function(){p.next().is("pre")&&p.next().text(" ")}})}
function formatSize(a){return a&&"?"!=a?'<a class="sizedetails" href="javascript:void(0)">'+formatNumber(a/1E3/1E3)+"</a>":"N/A"}function formatTimeRatio(a){return a&&"?"!=a?'<a class="timedetails" href="javascript:void(0)" data-field="'+this.field+'">'+formatNumber(a)+"</a>":"N/A"}
function timeDetails(a,b,c,e){p="";"d_"==$(this).data("field").substr(0,2)&&(p="d_");ref="samtools";-1!=$("#table").data("url").indexOf("_fastq")&&(ref="pigz");html=[];html.push("<dt>Original time</dt><dd>"+formatTime(c[p+"walltime"])+"</dd>");html.push("<dt>"+indict(ref,tools)+" time</dt><dd>"+formatTime(c[p+"walltime"]/c[p+"walltime_ratio"])+"</dd>");html.push("<dt>Ratio</dt><dd>"+formatNumber(c[p+"walltime_ratio"])+"</dd>");$(this).attr("data-content",'<dl class="dl-small">'+html.join("")+"</dl>")}
function sizeDetails(a,b,c,e){html=[];f=["seq","pe","aux","qual","rname"];$.each(f,function(a,b){c[b]&&html.push("<dt>"+indict(b,window.fields)+"</dt><dd>"+formatNumber(c[b]/1E3/1E3)+" MB</dd>")});$(this).attr("data-content",'<dl class="dl-small">'+html.join("")+"</dl>")}$("body").on("click",function(a){$("[data-original-title]").each(function(){$(this).is(a.target)||0!==$(this).has(a.target).length||0!==$(".popover").has(a.target).length||$(this).popover("hide")})});
